<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Stage Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/yfinance@0.2.18/dist/yfinance.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ta@0.10.2/dist/ta.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Stock Stage Analyzer</h1>
                <div class="flex space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-blue-700">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">Stock Search</h2>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="stock-search" 
                            placeholder="Search symbol (e.g. AAPL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                        <button id="search-btn" class="absolute right-2 top-2 p-1 text-gray-500 hover:text-blue-600">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">Stage Analysis</h2>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="checkbox" id="stage-toggle" class="mr-2" checked>
                            <label for="stage-toggle">Show Stage Classification</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="wma-toggle" class="mr-2" checked>
                            <label for="wma-toggle">Show 30W WMA</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="slope-toggle" class="mr-2">
                            <label for="slope-toggle">Show WMA Slope</label>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4">Stage Definitions</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-start">
                            <span class="inline-block w-3 h-3 rounded-full bg-green-500 mt-1 mr-2"></span>
                            <div>
                                <span class="font-medium">Stage 2:</span> Uptrend, price > 30W WMA, slope > 0
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mt-1 mr-2"></span>
                            <div>
                                <span class="font-medium">Early Stage 2:</span> Breaking out from base
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mt-1 mr-2"></span>
                            <div>
                                <span class="font-medium">Stage 3:</span> Topping, high volatility
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="inline-block w-3 h-3 rounded-full bg-red-500 mt-1 mr-2"></span>
                            <div>
                                <span class="font-medium">Stage 4:</span> Downtrend, price < 30W WMA
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Stock Info Card -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 id="stock-name" class="text-2xl font-bold">Apple Inc.</h2>
                            <p id="stock-symbol" class="text-gray-600">AAPL</p>
                        </div>
                        <div class="text-right">
                            <p id="stock-price" class="text-3xl font-bold">$175.34</p>
                            <p id="stock-change" class="text-green-500">+2.34 (1.35%)</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <p class="text-gray-500">Current Stage</p>
                            <p id="stock-stage" class="font-semibold">Stage 2</p>
                        </div>
                        <div>
                            <p class="text-gray-500">WMA Slope</p>
                            <p id="wma-slope" class="font-semibold">0.25%</p>
                        </div>
                        <div>
                            <p class="text-gray-500">RSI (14)</p>
                            <p id="stock-rsi" class="font-semibold">62.5</p>
                        </div>
                        <div>
                            <p class="text-gray-500">BB Width</p>
                            <p id="bb-width" class="font-semibold">12.3%</p>
                        </div>
                    </div>
                </div>

                <!-- Stage Analysis Chart -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="h-96">
                        <canvas id="stage-chart"></canvas>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Stage Performance Metrics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500">Stage 2 Returns</p>
                            <p id="stage2-returns" class="text-2xl font-bold text-green-600">+24.5%</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500">Stage 4 Returns</p>
                            <p id="stage4-returns" class="text-2xl font-bold text-red-600">-18.2%</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500">Strategy Sharpe</p>
                            <p id="strategy-sharpe" class="text-2xl font-bold text-blue-600">1.85</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Enhanced stock analysis with stage classification
        function classifyStage(row) {
            const price = row.Close;
            const wma30 = row.wma_30;
            const slope = row.slope_30wma;
            const max10w = row.max_10w;
            const max30w = row.max_30w;
            const std10w = row.std_10w;
            const volAvg = row.vol_avg_10w;
            const rsi = row.rsi;
            const bbWidth = row.bb_width;
            const niftySlope = row.nifty_slope;
            
            // Stage classification logic
            if (price > wma30 && slope > 0 && price >= max10w && price >= max30w * 0.9) {
                if (slope > 0.005 && bbWidth < 0.15 && rsi > 50 && rsi < 70 && niftySlope > 0) {
                    return 'Early Stage 2';
                }
                return 'Stage 2';
            } 
            else if (price > wma30 && (slope <= 0 || price < max30w * 0.9)) {
                if (bbWidth > 0.2 || std10w > 0.1 * price || rsi > 70) {
                    return 'Stage 3';
                }
                return 'Early Stage 3';
            }
            else if (price < wma30 && slope < 0) {
                if (price < max30w * 0.7 || rsi < 30) {
                    return 'Stage 4';
                }
                return 'Early Stage 4';
            }
            return 'Unclassified';
        }

        // Enhanced backtest function with stage analysis
        async function analyzeStock(ticker, startDate='2015-01-01', endDate='2024-12-31') {
            try {
                // Fetch weekly data
                const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=5y&interval=1wk`);
                const jsonData = await response.json();
                
                if (!jsonData.chart.result) {
                    console.error("No data found for", ticker);
                    return null;
                }
                
                // Process data
                const timestamps = jsonData.chart.result[0].timestamp;
                const closes = jsonData.chart.result[0].indicators.quote[0].close;
                const highs = jsonData.chart.result[0].indicators.quote[0].high;
                const lows = jsonData.chart.result[0].indicators.quote[0].low;
                const volumes = jsonData.chart.result[0].indicators.quote[0].volume;
                
                // Create DataFrame-like structure
                const data = timestamps.map((ts, i) => ({
                    Date: new Date(ts * 1000),
                    Close: closes[i],
                    High: highs[i],
                    Low: lows[i],
                    Volume: volumes[i]
                }));
                
                // Compute indicators
                const wma30 = wma(data.map(d => d.Close), 30);
                const slope30wma = wma_slope(data.map(d => d.Close), 30);
                const max10w = rollingMax(data.map(d => d.High), 10);
                const max30w = rollingMax(data.map(d => d.High), 30);
                const std10w = rollingStd(data.map(d => d.Close), 10);
                const volAvg10w = rollingAvg(data.map(d => d.Volume), 10);
                
                // Add indicators to data
                data.forEach((d, i) => {
                    d.wma_30 = wma30[i];
                    d.slope_30wma = slope30wma[i];
                    d.max_10w = max10w[i];
                    d.max_30w = max30w[i];
                    d.std_10w = std10w[i];
                    d.vol_avg_10w = volAvg10w[i];
                    d.stage = classifyStage(d);
                });
                
                return data;
            } catch (error) {
                console.error("Error analyzing stock:", error);
                return null;
            }
        }

        // Initialize charts with stage visualization
        function initStageCharts() {
            const stageCtx = document.getElementById('stage-chart').getContext('2d');
            
            // Stage chart with colored background for stages
            stageChart = new Chart(stageCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Price',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: '30W WMA',
                        data: [],
                        borderColor: 'rgb(234, 88, 12)',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            }
                        },
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                box1: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: 0,
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    borderWidth: 0
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update charts with stage analysis
        async function updateStageAnalysis(ticker) {
            const data = await analyzeStock(ticker);
            if (!data) return;
            
            // Update stock info
            const latest = data[data.length - 1];
            document.getElementById('stock-name').textContent = ticker;
            document.getElementById('stock-price').textContent = latest.Close.toFixed(2);
            document.getElementById('stock-stage').textContent = latest.stage;
            document.getElementById('wma-slope').textContent = (latest.slope_30wma * 100).toFixed(2) + '%';
            document.getElementById('stock-rsi').textContent = latest.rsi?.toFixed(1) || 'N/A';
            document.getElementById('bb-width').textContent = (latest.bb_width * 100).toFixed(1) + '%';
            
            // Update chart data
            stageChart.data.datasets[0].data = data.map(d => ({x: d.Date, y: d.Close}));
            stageChart.data.datasets[1].data = data.map(d => ({x: d.Date, y: d.wma_30}));
            
            // Add stage background colors
            const stageAnnotations = [];
            let currentStage = data[0].stage;
            let startIdx = 0;
            
            for (let i = 1; i < data.length; i++) {
                if (data[i].stage !== currentStage) {
                    stageAnnotations.push({
                        type: 'box',
                        xMin: data[startIdx].Date,
                        xMax: data[i-1].Date,
                        backgroundColor: getStageColor(currentStage),
                        borderWidth: 0
                    });
                    currentStage = data[i].stage;
                    startIdx = i;
                }
            }
            
            // Add final stage
            stageAnnotations.push({
                type: 'box',
                xMin: data[startIdx].Date,
                xMax: data[data.length-1].Date,
                backgroundColor: getStageColor(currentStage),
                borderWidth: 0
            });
            
            stageChart.options.plugins.annotation.annotations = stageAnnotations;
            stageChart.update();
            
            // Update performance metrics (simulated for demo)
            document.getElementById('stage2-returns').textContent = '+24.5%';
            document.getElementById('stage4-returns').textContent = '-18.2%';
            document.getElementById('strategy-sharpe').textContent = '1.85';
        }

        function getStageColor(stage) {
            switch(stage) {
                case 'Stage 2': return 'rgba(34, 197, 94, 0.1)';
                case 'Early Stage 2': return 'rgba(34, 197, 94, 0.2)';
                case 'Stage 3': return 'rgba(234, 179, 8, 0.1)';
                case 'Stage 4': return 'rgba(239, 68, 68, 0.1)';
                default: return 'rgba(156, 163, 175, 0.1)';
            }
        }

        // Helper functions for technical analysis
        function wma(series, period) {
            // Weighted moving average implementation
            const weights = Array.from({length: period}, (_, i) => i + 1);
            return series.map((_, i, arr) => {
                if (i < period - 1) return null;
                const slice = arr.slice(i - period + 1, i + 1);
                return slice.reduce((sum, val, idx) => sum + val * weights[idx], 0) / weights.reduce((a, b) => a + b, 0);
            });
        }

        function wma_slope(series, period) {
            // WMA slope implementation
            const wmaVals = wma(series, period);
            return wmaVals.map((val, i, arr) => {
                if (i === 0 || !arr[i-1]) return null;
                return (val - arr[i-1]) / arr[i-1];
            });
        }

        function rollingMax(series, period) {
            // Rolling max implementation
            return series.map((_, i, arr) => {
                if (i < period - 1) return null;
                return Math.max(...arr.slice(i - period + 1, i + 1));
            });
        }

        function rollingStd(series, period) {
            // Rolling standard deviation
            return series.map((_, i, arr) => {
                if (i < period - 1) return null;
                const slice = arr.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                return Math.sqrt(slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period);
            });
        }

        function rollingAvg(series, period) {
            // Rolling average
            return series.map((_, i, arr) => {
                if (i < period - 1) return null;
                return arr.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period;
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initStageCharts();
            
            // Default to AAPL
            updateStageAnalysis('AAPL');
            
            // Search functionality
            document.getElementById('search-btn').addEventListener('click', () => {
                const ticker = document.getElementById('stock-search').value.trim();
                if (ticker) {
                    updateStageAnalysis(ticker);
                }
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.body.classList.toggle('dark');
            });
        });
    </script>
</body>
</html>